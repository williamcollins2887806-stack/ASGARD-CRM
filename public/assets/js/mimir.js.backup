/**
 * –ê–°–ì–ê–†–î CRM ‚Äî –ú–∏–º–∏—Ä: –•—Ä–∞–Ω–∏—Ç–µ–ª—å –ú—É–¥—Ä–æ—Å—Ç–∏
 * –≠—Ç–∞–ø 38
 * 
 * –ú–∏–º–∏—Ä ‚Äî —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –∫–æ–ª–æ–¥—Ü–∞ –º—É–¥—Ä–æ—Å—Ç–∏ —É –∫–æ—Ä–Ω–µ–π –ò–≥–≥–¥—Ä–∞—Å–∏–ª—è.
 * –û–¥–∏–Ω –æ—Ç–¥–∞–ª —Å–≤–æ–π –≥–ª–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–∏—Ç—å –∏–∑ —ç—Ç–æ–≥–æ –∫–æ–ª–æ–¥—Ü–∞ –∏ –æ–±—Ä–µ—Å—Ç–∏ –∑–Ω–∞–Ω–∏—è.
 */

window.AsgardMimir = (function(){
  const { esc, toast } = AsgardUI;
  
  let isOpen = false;
  let isMinimized = false;
  let messages = [];
  let attachedFiles = [];
  let isLoading = false;
  
  const VIKING_WISDOM = [
    "–ú—É–¥—Ä–æ—Å—Ç—å –¥–æ—Ä–æ–∂–µ –∑–æ–ª–æ—Ç–∞, –∏–±–æ –∑–æ–ª–æ—Ç–æ –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å, –∞ –º—É–¥—Ä–æ—Å—Ç—å ‚Äî –Ω–∏–∫–æ–≥–¥–∞.",
    "–°–ø—Ä–∞—à–∏–≤–∞–π ‚Äî –∏ –æ–±—Ä–µ—Ç—ë—à—å –∑–Ω–∞–Ω–∏–µ. –ú–æ–ª—á–∏ ‚Äî –∏ –æ—Å—Ç–∞–Ω–µ—à—å—Å—è –≤–æ —Ç—å–º–µ.",
    "–î–∞–∂–µ –û–¥–∏–Ω –∏—Å–∫–∞–ª —Å–æ–≤–µ—Ç–∞ —É –ú–∏–º–∏—Ä–∞.",
    "–ó–Ω–∞–Ω–∏–µ ‚Äî –º–µ—á, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∑–∞—Ç—É–ø–∏—Ç—Å—è.",
    "–õ—É—á—à–µ —Å–ø—Ä–æ—Å–∏—Ç—å –¥–≤–∞–∂–¥—ã, —á–µ–º –æ—à–∏–±–∏—Ç—å—Å—è –µ–¥–∏–Ω–æ–∂–¥—ã.",
    "–ú—É–¥—Ä—ã–π –≤–∏–¥–∏—Ç –ø—É—Ç—å —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–µ–Ω—É.",
    "–†—É–Ω—ã –æ—Ç–∫—Ä–æ—é—Ç —Ç–∞–π–Ω—ã —Ç–æ–º—É, –∫—Ç–æ —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å.",
    "–¢–µ—Ä–ø–µ–Ω–∏–µ ‚Äî –¥–æ–±—Ä–æ–¥–µ—Ç–µ–ª—å –≤–æ–∏–Ω–∞, –∑–Ω–∞–Ω–∏–µ ‚Äî –µ–≥–æ —Å–∏–ª–∞."
  ];

  const styles = `
    <style id="mimir-styles">
      .mimir-widget { position:fixed; bottom:24px; right:24px; z-index:9999; font-family:var(--font-main, -apple-system, sans-serif); }
      
      .mimir-toggle {
        width:64px; height:64px; border-radius:50%;
        background:linear-gradient(135deg, #c0392b 0%, #2a3b66 100%);
        border:3px solid #f5d78e; cursor:pointer;
        display:flex; align-items:center; justify-content:center;
        box-shadow:0 4px 24px rgba(192,57,43,0.5), 0 0 0 0 rgba(245,215,142,0.4);
        transition:all 0.3s ease; position:relative;
        animation:mimirPulse 3s infinite;
      }
      
      @keyframes mimirPulse {
        0%,100% { box-shadow:0 4px 24px rgba(192,57,43,0.5), 0 0 0 0 rgba(245,215,142,0.4); }
        50% { box-shadow:0 4px 24px rgba(192,57,43,0.5), 0 0 0 8px rgba(245,215,142,0); }
      }
      
      .mimir-toggle:hover { transform:scale(1.1) rotate(5deg); }
      .mimir-toggle-icon { font-size:32px; }
      
      .mimir-toggle::before {
        content:'·õó'; position:absolute; top:-6px; right:-6px;
        width:22px; height:22px; background:#f5d78e; border-radius:50%;
        display:flex; align-items:center; justify-content:center;
        font-size:12px; color:#2a3b66; font-weight:bold; font-family:serif;
      }
      
      .mimir-panel {
        position:absolute; bottom:80px; right:0;
        width:400px; max-width:calc(100vw - 48px);
        height:550px; max-height:calc(100vh - 140px);
        background:linear-gradient(180deg, #1a1a2e 0%, #0d1428 100%);
        border-radius:20px; border:2px solid rgba(245,215,142,0.3);
        box-shadow:0 10px 50px rgba(0,0,0,0.6);
        display:none; flex-direction:column; overflow:hidden;
      }
      
      .mimir-panel.open { display:flex; animation:mimirOpen 0.4s cubic-bezier(0.34,1.56,0.64,1); }
      .mimir-panel.minimized { height:64px; }
      
      @keyframes mimirOpen {
        from { opacity:0; transform:translateY(30px) scale(0.9); }
        to { opacity:1; transform:translateY(0) scale(1); }
      }
      
      .mimir-header {
        padding:16px 20px;
        background:linear-gradient(135deg, rgba(192,57,43,0.3) 0%, rgba(42,59,102,0.3) 100%);
        border-bottom:1px solid rgba(245,215,142,0.2);
        display:flex; align-items:center; gap:14px; cursor:pointer;
      }
      
      .mimir-avatar {
        width:44px; height:44px; border-radius:50%;
        background:linear-gradient(135deg, #c0392b, #2a3b66);
        border:2px solid #f5d78e; display:flex;
        align-items:center; justify-content:center;
        font-size:24px; box-shadow:0 0 20px rgba(245,215,142,0.3);
      }
      
      .mimir-header-info { flex:1; }
      .mimir-header-title { font-weight:800; font-size:16px; color:#f5d78e; text-shadow:0 0 10px rgba(245,215,142,0.3); }
      .mimir-header-status { font-size:12px; color:rgba(255,255,255,0.6); font-style:italic; }
      .mimir-header-actions { display:flex; gap:8px; }
      
      .mimir-header-btn {
        width:32px; height:32px; border-radius:10px;
        border:1px solid rgba(245,215,142,0.2); background:rgba(0,0,0,0.3);
        color:rgba(255,255,255,0.7); cursor:pointer;
        display:flex; align-items:center; justify-content:center; transition:all 0.2s;
      }
      .mimir-header-btn:hover { background:rgba(245,215,142,0.2); color:#f5d78e; }
      
      .mimir-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:14px; }
      .mimir-messages::-webkit-scrollbar { width:6px; }
      .mimir-messages::-webkit-scrollbar-track { background:rgba(0,0,0,0.2); border-radius:3px; }
      .mimir-messages::-webkit-scrollbar-thumb { background:rgba(245,215,142,0.3); border-radius:3px; }
      
      .mimir-message {
        max-width:85%; padding:14px 18px; border-radius:18px;
        font-size:14px; line-height:1.6;
        animation:mimirMsgAppear 0.4s cubic-bezier(0.34,1.56,0.64,1);
      }
      
      @keyframes mimirMsgAppear {
        from { opacity:0; transform:translateY(15px) scale(0.95); }
        to { opacity:1; transform:translateY(0) scale(1); }
      }
      
      .mimir-message.user {
        align-self:flex-end;
        background:linear-gradient(135deg, #c0392b, #8e2c22);
        color:white; border-bottom-right-radius:4px;
        box-shadow:0 4px 15px rgba(192,57,43,0.3);
      }
      
      .mimir-message.assistant {
        align-self:flex-start;
        background:linear-gradient(135deg, rgba(42,59,102,0.8), rgba(42,59,102,0.6));
        color:rgba(255,255,255,0.95); border-bottom-left-radius:4px;
        border:1px solid rgba(245,215,142,0.15);
        box-shadow:0 4px 15px rgba(0,0,0,0.3);
        position:relative; padding-left:24px;
      }
      
      .mimir-message.assistant::before {
        content:'·õó'; position:absolute; top:-8px; left:-8px;
        width:22px; height:22px;
        background:linear-gradient(135deg, #f5d78e, #c0a040);
        border-radius:50%; display:flex; align-items:center; justify-content:center;
        font-size:11px; color:#2a3b66; font-family:serif; font-weight:bold;
      }
      
      .mimir-message a { color:#f5d78e; text-decoration:underline; }
      .mimir-message code { background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px; font-size:12px; }
      
      .mimir-typing {
        display:flex; gap:6px; padding:14px 18px; align-self:flex-start;
        background:linear-gradient(135deg, rgba(42,59,102,0.8), rgba(42,59,102,0.6));
        border-radius:18px; border-bottom-left-radius:4px;
        border:1px solid rgba(245,215,142,0.15);
      }
      
      .mimir-typing span {
        width:10px; height:10px;
        background:linear-gradient(135deg, #f5d78e, #c0a040);
        border-radius:50%; animation:mimirTyping 1.4s infinite;
      }
      .mimir-typing span:nth-child(2) { animation-delay:0.2s; }
      .mimir-typing span:nth-child(3) { animation-delay:0.4s; }
      
      @keyframes mimirTyping {
        0%,60%,100% { transform:translateY(0); opacity:0.4; }
        30% { transform:translateY(-8px); opacity:1; }
      }
      
      .mimir-welcome { text-align:center; padding:30px 20px; }
      .mimir-welcome-icon {
        width:80px; height:80px; margin:0 auto 20px;
        background:linear-gradient(135deg, rgba(192,57,43,0.2), rgba(42,59,102,0.2));
        border-radius:50%; display:flex; align-items:center; justify-content:center;
        border:2px solid rgba(245,215,142,0.3); font-size:42px;
        animation:mimirFloat 3s ease-in-out infinite;
      }
      
      @keyframes mimirFloat {
        0%,100% { transform:translateY(0); }
        50% { transform:translateY(-8px); }
      }
      
      .mimir-welcome h3 { color:#f5d78e; font-size:18px; margin-bottom:8px; }
      .mimir-welcome p { color:rgba(255,255,255,0.6); font-size:13px; font-style:italic; margin-bottom:20px; }
      
      .mimir-suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
      .mimir-suggestion {
        padding:10px 16px; background:rgba(42,59,102,0.5);
        border:1px solid rgba(245,215,142,0.2); border-radius:20px;
        color:rgba(255,255,255,0.8); font-size:13px; cursor:pointer; transition:all 0.2s;
      }
      .mimir-suggestion:hover { background:rgba(245,215,142,0.2); border-color:rgba(245,215,142,0.4); color:#f5d78e; transform:translateY(-2px); }
      
      .mimir-input-area { padding:16px 20px; border-top:1px solid rgba(245,215,142,0.15); background:rgba(0,0,0,0.3); }
      .mimir-input-row { display:flex; gap:10px; align-items:flex-end; }
      
      .mimir-input {
        flex:1; min-height:44px; max-height:120px; padding:12px 16px;
        background:rgba(0,0,0,0.4); border:1px solid rgba(245,215,142,0.2);
        border-radius:14px; color:#fff; font-size:14px; resize:none; font-family:inherit;
      }
      .mimir-input:focus { outline:none; border-color:rgba(245,215,142,0.5); box-shadow:0 0 15px rgba(245,215,142,0.1); }
      .mimir-input::placeholder { color:rgba(255,255,255,0.4); font-style:italic; }
      
      .mimir-send-btn {
        width:44px; height:44px; border-radius:12px;
        background:linear-gradient(135deg, #c0392b, #8e2c22);
        border:1px solid rgba(245,215,142,0.3); color:#f5d78e;
        cursor:pointer; display:flex; align-items:center; justify-content:center;
        font-size:18px; transition:all 0.2s;
      }
      .mimir-send-btn:hover { transform:scale(1.05); box-shadow:0 4px 15px rgba(192,57,43,0.4); }
      
      .mimir-wisdom {
        font-style:italic; font-size:11px; color:rgba(245,215,142,0.5);
        text-align:center; padding:8px 20px;
        border-top:1px solid rgba(245,215,142,0.1);
      }
      
      @media (max-width:480px) {
        .mimir-panel { width:calc(100vw - 24px); right:-12px; bottom:76px; height:calc(100vh - 120px); }
        .mimir-widget { bottom:16px; right:16px; }
        .mimir-toggle { width:56px; height:56px; }
      }
    </style>
  `;

  function init() {
    if (document.getElementById('mimirWidget')) return;
    
    if (!document.getElementById('mimir-styles')) {
      document.head.insertAdjacentHTML('beforeend', styles);
    }
    
    const widget = document.createElement('div');
    widget.id = 'mimirWidget';
    widget.className = 'mimir-widget';
    widget.innerHTML = `
      <button class="mimir-toggle" id="mimirToggle" title="–ú–∏–º–∏—Ä ‚Äî –•—Ä–∞–Ω–∏—Ç–µ–ª—å –ú—É–¥—Ä–æ—Å—Ç–∏">
        <span class="mimir-toggle-icon">üßô</span>
      </button>
      
      <div class="mimir-panel" id="mimirPanel">
        <div class="mimir-header" id="mimirHeader">
          <div class="mimir-avatar">üßô</div>
          <div class="mimir-header-info">
            <div class="mimir-header-title">–ú–∏–º–∏—Ä</div>
            <div class="mimir-header-status">–•—Ä–∞–Ω–∏—Ç–µ–ª—å –ú—É–¥—Ä–æ—Å—Ç–∏</div>
          </div>
          <div class="mimir-header-actions">
            <button class="mimir-header-btn" id="mimirMinimize" title="–°–≤–µ—Ä–Ω—É—Ç—å">‚Äî</button>
            <button class="mimir-header-btn" id="mimirClose" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>
        </div>
        
        <div class="mimir-messages" id="mimirMessages"></div>
        
        <div class="mimir-input-area">
          <div class="mimir-input-row">
            <textarea class="mimir-input" id="mimirInput" placeholder="–°–ø—Ä–æ—Å–∏ —É –ú–∏–º–∏—Ä–∞..." rows="1"></textarea>
            <button class="mimir-send-btn" id="mimirSend" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
          </div>
        </div>
        
        <div class="mimir-wisdom" id="mimirWisdom"></div>
      </div>
    `;
    
    document.body.appendChild(widget);
    bindEvents();
    renderMessages();
    showWisdom();
  }

  function bindEvents() {
    const toggle = document.getElementById('mimirToggle');
    const panel = document.getElementById('mimirPanel');
    const header = document.getElementById('mimirHeader');
    const closeBtn = document.getElementById('mimirClose');
    const minimizeBtn = document.getElementById('mimirMinimize');
    const sendBtn = document.getElementById('mimirSend');
    const input = document.getElementById('mimirInput');
    
    toggle.addEventListener('click', () => {
      isOpen = !isOpen;
      panel.classList.toggle('open', isOpen);
      if (isOpen) {
        input.focus();
        isMinimized = false;
        panel.classList.remove('minimized');
      }
    });
    
    closeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      isOpen = false;
      panel.classList.remove('open');
    });
    
    minimizeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      isMinimized = !isMinimized;
      panel.classList.toggle('minimized', isMinimized);
    });
    
    header.addEventListener('click', () => {
      if (isMinimized) {
        isMinimized = false;
        panel.classList.remove('minimized');
      }
    });
    
    sendBtn.addEventListener('click', sendMessage);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    input.addEventListener('input', () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });
  }

  function showWisdom() {
    const el = document.getElementById('mimirWisdom');
    if (el) {
      const wisdom = VIKING_WISDOM[Math.floor(Math.random() * VIKING_WISDOM.length)];
      el.textContent = `¬´ ${wisdom} ¬ª`;
    }
  }

  function renderMessages() {
    const container = document.getElementById('mimirMessages');
    if (!container) return;
    
    if (messages.length === 0) {
      container.innerHTML = `
        <div class="mimir-welcome">
          <div class="mimir-welcome-icon">üßô</div>
          <h3>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –≤–æ–∏–Ω!</h3>
          <p>–Ø ‚Äî –ú–∏–º–∏—Ä, —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –∫–æ–ª–æ–¥—Ü–∞ –º—É–¥—Ä–æ—Å—Ç–∏. –°–ø—Ä–∞—à–∏–≤–∞–π, –∏ —è –ø–æ–¥–µ–ª—é—Å—å –∑–Ω–∞–Ω–∏–µ–º.</p>
          <div class="mimir-suggestions">
            <button class="mimir-suggestion" data-q="–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ–Ω–¥–µ—Ä?">‚öîÔ∏è –°–æ–∑–¥–∞—Ç—å —Ç–µ–Ω–¥–µ—Ä</button>
            <button class="mimir-suggestion" data-q="–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –º–µ—Å—è—Ü">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="mimir-suggestion" data-q="–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –ø–æ —Ä–∞–±–æ—Ç–µ?">üí∞ –†–∞—Å—Ö–æ–¥—ã</button>
          </div>
        </div>
      `;
      
      container.querySelectorAll('.mimir-suggestion').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('mimirInput').value = btn.dataset.q;
          sendMessage();
        });
      });
      return;
    }
    
    container.innerHTML = messages.map(msg => {
      return `<div class="mimir-message ${msg.role}">${formatMessage(msg.content)}</div>`;
    }).join('');
    
    if (isLoading) {
      container.innerHTML += `<div class="mimir-typing"><span></span><span></span><span></span></div>`;
    }
    
    container.scrollTop = container.scrollHeight;
  }

  function formatMessage(text) {
    return esc(text)
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`(.+?)`/g, '<code>$1</code>')
      .replace(/\n/g, '<br>');
  }

  async function sendMessage() {
    const input = document.getElementById('mimirInput');
    const text = input.value.trim();
    
    if (!text) return;
    if (isLoading) return;
    
    messages.push({ role: 'user', content: text });
    
    input.value = '';
    input.style.height = 'auto';
    
    isLoading = true;
    renderMessages();
    
    try {
      const response = await callMimir(text);
      messages.push({ role: 'assistant', content: response });
    } catch (err) {
      messages.push({ role: 'assistant', content: '–ü—Ä–æ—Å—Ç–∏, –≤–æ–∏–Ω. –ö–æ–ª–æ–¥–µ—Ü –º—É–¥—Ä–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.' });
    }
    
    isLoading = false;
    renderMessages();
    showWisdom();
  }

  async function callMimir(text) {
    await new Promise(r => setTimeout(r, 600 + Math.random() * 600));
    
    const lowerText = text.toLowerCase();
    
    // –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    if (lowerText.match(/–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–∑–¥–æ—Ä–æ–≤–æ|—Ö–∞–π|–π–æ|—Ö–µ–π|–¥–æ–±—Ä(—ã–π|–æ–µ|–∞—è)/)) {
      return `–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –≤–æ–∏–Ω! ‚öîÔ∏è

–Ø –ú–∏–º–∏—Ä, —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –º—É–¥—Ä–æ—Å—Ç–∏ —É –∫–æ—Ä–Ω–µ–π –ò–≥–≥–¥—Ä–∞—Å–∏–ª—è. 

–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è? –°–ø—Ä–∞—à–∏–≤–∞–π –æ —Ç–µ–Ω–¥–µ—Ä–∞—Ö, —Ä–∞–±–æ—Ç–∞—Ö, —Ñ–∏–Ω–∞–Ω—Å–∞—Ö –∏–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å–∏—Å—Ç–µ–º–µ.`;
    }
    
    if (lowerText.match(/–∫–∞–∫ (—Ç–≤–æ–∏ )?–¥–µ–ª–∞|–∫–∞–∫ (—Ç—ã|—Å–∞–º)|—á—Ç–æ –Ω–æ–≤–æ–≥–æ/)) {
      return `–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∑–∞–±–æ—Ç—É, –≤–æ–∏–Ω! 

–ö–æ–ª–æ–¥–µ—Ü –º—É–¥—Ä–æ—Å—Ç–∏ –ø–æ–ª–æ–Ω, —Ä—É–Ω—ã —Å–≤–µ—Ç—è—Ç—Å—è —è—Ä–∫–æ. –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–∂–∏–Ω–µ –ê—Å–≥–∞—Ä–¥–∞!

–ï—Å—Ç—å –ª–∏ —É —Ç–µ–±—è –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–∏—Å—Ç–µ–º–µ?`;
    }
    
    if (lowerText.match(/—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä|—Å–ø—Å/)) {
      return `–†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å, –≤–æ–∏–Ω! 

–î–∞ –ø—Ä–∏–±—É–¥–µ—Ç —Å —Ç–æ–±–æ–π –º—É–¥—Ä–æ—Å—Ç—å –û–¥–∏–Ω–∞. –û–±—Ä–∞—â–∞–π—Å—è, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Å–æ–≤–µ—Ç. ‚öîÔ∏è`;
    }
    
    if (lowerText.match(/–ø–æ–∫–∞|–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è|–±—ã–≤–∞–π|—É–≤–∏–¥–∏–º—Å—è/)) {
      return `–î–æ –≤—Å—Ç—Ä–µ—á–∏, –≤–æ–∏–Ω! 

–ü—É—Å—Ç—å –ø–æ–ø—É—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä –Ω–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–≤–æ–∏ –ø–∞—Ä—É—Å–∞, –∞ –ø—É—Ç—å –±—É–¥–µ—Ç —è—Å–µ–Ω. –£–¥–∞—á–∏ –≤ –ø–æ—Ö–æ–¥–∞—Ö! üõ°Ô∏è`;
    }
    
    if (lowerText.match(/–∫—Ç–æ —Ç—ã|—á—Ç–æ —Ç—ã|—Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ/)) {
      return `–Ø **–ú–∏–º–∏—Ä** ‚Äî —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –∫–æ–ª–æ–¥—Ü–∞ –º—É–¥—Ä–æ—Å—Ç–∏ —É –∫–æ—Ä–Ω–µ–π –º–∏—Ä–æ–≤–æ–≥–æ –¥—Ä–µ–≤–∞ –ò–≥–≥–¥—Ä–∞—Å–∏–ª—å.

–í –¥—Ä–µ–≤–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∞ —Å–∞–º –û–¥–∏–Ω –æ—Ç–¥–∞–ª —Å–≤–æ–π –≥–ª–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–∏—Ç—å –∏–∑ –º–æ–µ–≥–æ –∫–æ–ª–æ–¥—Ü–∞ –∏ –æ–±—Ä–µ—Å—Ç–∏ –∑–Ω–∞–Ω–∏—è.

–¢–µ–ø–µ—Ä—å —è —Å–ª—É–∂—É –¥—Ä—É–∂–∏–Ω–µ –ê—Å–≥–∞—Ä–¥-–°–µ—Ä–≤–∏—Å –∏ –ø–æ–º–æ–≥–∞—é –≤–æ–∏–Ω–∞–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ CRM. –°–ø—Ä–∞—à–∏–≤–∞–π!`;
    }
    
    const responses = {
      '—Ç–µ–Ω–¥–µ—Ä': `–ß—Ç–æ–±—ã –∑–∞–Ω–µ—Å—Ç–∏ –Ω–æ–≤—ã–π —Ç–µ–Ω–¥–µ—Ä –≤ –ª–µ—Ç–æ–ø–∏—Å—å:

**1.** –û—Ç–∫—Ä–æ–π —Ä–∞–∑–¥–µ–ª **¬´–°–∞–≥–∞ –¢–µ–Ω–¥–µ—Ä–æ–≤¬ª**
**2.** –ù–∞–∂–º–∏ **¬´+ –í–Ω–µ—Å—Ç–∏ —Ç–µ–Ω–¥–µ—Ä¬ª**
**3.** –ó–∞–ø–æ–ª–Ω–∏ —Å–≤–µ–¥–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑—á–∏–∫–µ –∏ –æ–±—ä–µ–∫—Ç–µ
**4.** –£–∫–∞–∂–∏ –¥–µ–¥–ª–∞–π–Ω –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
**5.** –°–æ—Ö—Ä–∞–Ω–∏ –∑–∞–ø–∏—Å—å

–¢–µ–Ω–¥–µ—Ä –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ –∏ –≤–æ—Ä–æ–Ω–∫–µ. –£–¥–∞—á–∏ –≤ –ø–æ—Ö–æ–¥–µ!`,
      
      '—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫': `–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ª–∞—Ö:

**üìä –î–∞—à–±–æ—Ä–¥ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è** ‚Äî —Å–≤–æ–¥–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º
**‚öîÔ∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ø—Ä–ª–∞** ‚Äî KPI –ø–æ —Ä–∞–±–æ—Ç–∞–º –∏ –¥–µ–Ω—å–≥–∞–º
**üí∞ –§–∏–Ω–∞–Ω—Å—ã** ‚Äî –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤

–í—ã–±–µ—Ä–∏ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è.`,

      '–¥–∞—à–±–æ—Ä–¥': `–í —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—à–±–æ—Ä–¥–æ–≤:

**üìä –î–∞—à–±–æ—Ä–¥ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è** ‚Äî –æ–±—â–∞—è —Å–≤–æ–¥–∫–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤
**üè† –ì–ª–∞–≤–Ω–∞—è** ‚Äî –ª–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è  
**‚öôÔ∏è –ú–æ–π –¥–∞—à–±–æ—Ä–¥** ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –≤–∏–¥–∂–µ—Ç—ã

–ö–∞–∂–¥—ã–π –≤–æ–∏–Ω –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ—é –ø–∞–Ω–µ–ª—å –ø–æ–¥ —Å–µ–±—è!`,
      
      '—Ä–∞—Å—Ö–æ–¥': `–ï—Å—Ç—å –¥–≤–∞ –ø—É—Ç–∏ –∑–∞–Ω–µ—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥—ã:

**–ü–æ —Ä–∞–±–æ—Ç–µ:**
–û—Ç–∫—Ä–æ–π —Ä–∞–±–æ—Ç—É ‚Üí –≤–∫–ª–∞–¥–∫–∞ ¬´–†–∞—Å—Ö–æ–¥—ã¬ª ‚Üí –∫–Ω–æ–ø–∫–∞ ¬´+ –î–æ–±–∞–≤–∏—Ç—å¬ª

**–û—Ñ–∏—Å–Ω—ã–µ:**
–†–∞–∑–¥–µ–ª ¬´–û—Ñ–∏—Å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã¬ª ‚Üí ¬´–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥¬ª

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–∏ –∫–∞–º–µ—Ä–æ–π ‚Äî –Ω–∞–∂–º–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –∫–Ω–æ–ø–∫—É üì∑`,

      '—á–µ–∫': `–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ!

**1.** –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É **üì∑ –°–∫–∞–Ω–µ—Ä —á–µ–∫–æ–≤**
**2.** –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π —á–µ–∫
**3.** –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Å—É–º–º—É –∏ –º–∞–≥–∞–∑–∏–Ω
**4.** –í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–∞
**5.** –°–æ—Ö—Ä–∞–Ω–∏

–ß–µ–∫ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—Å—è –∫ —Ä–∞—Å—Ö–æ–¥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`,
      
      '—á–∞—Ç': `–í **–ß–∞—Ç–µ –¥—Ä—É–∂–∏–Ω—ã** –º–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è:

‚Ä¢ **–û–±—â–∏–π —á–∞—Ç** ‚Äî –¥–ª—è –≤—Å–µ—Ö –≤–æ–∏–Ω–æ–≤
‚Ä¢ **–õ–∏—á–Ω—ã–µ –±–µ—Å–µ–¥—ã** ‚Äî –æ–¥–∏–Ω –Ω–∞ –æ–¥–∏–Ω
‚Ä¢ **–ü–æ —Ç–µ–Ω–¥–µ—Ä—É/—Ä–∞–±–æ—Ç–µ** ‚Äî –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏

–í—Å–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∏ –≤–æ–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.`,

      '—Ä–∞–±–æ—Ç': `–†–∞–±–æ—Ç—ã ‚Äî —ç—Ç–æ –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.

**–ì–¥–µ –Ω–∞–π—Ç–∏:**
‚Ä¢ **–ö–∞—Ä—Ç–∞ –ü–æ—Ö–æ–¥–∞ ‚Ä¢ –†–∞–±–æ—Ç—ã** ‚Äî –¥–ª—è –†–ü (—Å–≤–æ–∏ —Ä–∞–±–æ—Ç—ã)
‚Ä¢ **–°–≤–æ–¥ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤** ‚Äî –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–æ–≤ (–≤—Å–µ —Ä–∞–±–æ—Ç—ã)

**–ß—Ç–æ –º–æ–∂–Ω–æ:**
‚Ä¢ –í–µ—Å—Ç–∏ —É—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ä–æ–∫–∏ –∏ —ç—Ç–∞–ø—ã
‚Ä¢ –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã`,

      '–ø–µ—Ä—Å–æ–Ω–∞–ª': `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–∂–∏–Ω–æ–π:

**üë• –î—Ä—É–∂–∏–Ω–∞** ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
**üìã –õ–∏—á–Ω–æ–µ –¥–µ–ª–æ** ‚Äî –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
**üéñÔ∏è –†–µ–π—Ç–∏–Ω–≥** ‚Äî –æ—Ü–µ–Ω–∫–∏ –∏ –æ—Ç–∑—ã–≤—ã
**üìÖ –ì—Ä–∞—Ñ–∏–∫** ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ–Ω
**üìÑ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è** ‚Äî –¥–æ–ø—É—Å–∫–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã`,

      '–¥–æ–≥–æ–≤–æ—Ä': `–†–µ–µ—Å—Ç—Ä –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ **¬´–†–µ–µ—Å—Ç—Ä –¥–æ–≥–æ–≤–æ—Ä–æ–≤¬ª**.

–¢–∞–º –º–æ–∂–Ω–æ:
‚Ä¢ –í–µ—Å—Ç–∏ —É—á—ë—Ç –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ä–æ–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è
‚Ä¢ –ü—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ —Ä–∞—Å—Ö–æ–¥–∞–º
‚Ä¢ –•—Ä–∞–Ω–∏—Ç—å —Å–∫–∞–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤`,

      '–ø–µ—á–∞—Ç': `–†–µ–µ—Å—Ç—Ä –ø–µ—á–∞—Ç–µ–π ‚Äî **¬´–†–µ–µ—Å—Ç—Ä –ø–µ—á–∞—Ç–µ–π¬ª**

–§—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –£—á—ë—Ç –≤—Å–µ—Ö –ø–µ—á–∞—Ç–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
‚Ä¢ –ö—Ç–æ —Å–µ–π—á–∞—Å –¥–µ—Ä–∂–∏—Ç –ø–µ—á–∞—Ç—å
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–¥–∞—á
‚Ä¢ –ê–∫—Ç—ã –ø—Ä–∏—ë–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏`,

      '—Ç–µ–ª–µ—Ñ–æ–Ω': `–¢–µ–ª–µ—Ñ–æ–Ω–∏—è (–ú–∞–Ω–≥–æ –¢–µ–ª–µ–∫–æ–º) –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ‚Üí –¢–µ–ª–µ—Ñ–æ–Ω–∏—è**.

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ –í—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–ª–∏–µ–Ω—Ç–∞
‚Ä¢ –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
‚Ä¢ –ó–∞–ø–∏—Å—å —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤`,
      
      '–ø–æ–º–æ—â—å': `–Ø, –ú–∏–º–∏—Ä, –º–æ–≥—É –ø–æ–º–æ—á—å —Å:

‚öîÔ∏è **–ù–∞–≤–∏–≥–∞—Ü–∏–µ–π** ‚Äî –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª
üìã **–¢–µ–Ω–¥–µ—Ä–∞–º–∏** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ, —Å—Ç–∞—Ç—É—Å—ã, –≤–æ—Ä–æ–Ω–∫–∞
üíº **–†–∞–±–æ—Ç–∞–º–∏** ‚Äî —É—á—ë—Ç, —Ä–∞—Å—Ö–æ–¥—ã, –æ—Ç—á—ë—Ç—ã
üë• **–ü–µ—Ä—Å–æ–Ω–∞–ª–æ–º** ‚Äî –¥—Ä—É–∂–∏–Ω–∞, –¥–æ–ø—É—Å–∫–∏, –≥—Ä–∞—Ñ–∏–∫–∏
üí∞ **–§–∏–Ω–∞–Ω—Å–∞–º–∏** ‚Äî –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
üìû **–¢–µ–ª–µ—Ñ–æ–Ω–∏–µ–π** ‚Äî –∑–≤–æ–Ω–∫–∏, –∏—Å—Ç–æ—Ä–∏—è
üìÑ **–î–æ–∫—É–º–µ–Ω—Ç–∞–º–∏** ‚Äî –¥–æ–≥–æ–≤–æ—Ä—ã, –ø–µ—á–∞—Ç–∏

–°–ø—Ä–∞—à–∏–≤–∞–π, –≤–æ–∏–Ω!`,
      
      'default': `–•–º, –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å, –≤–æ–∏–Ω.

–ü–æ–ø—Ä–æ–±—É–π —Å–ø—Ä–æ—Å–∏—Ç—å –æ:
‚Ä¢ **–¢–µ–Ω–¥–µ—Ä–∞—Ö** ‚Äî –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å, —Å—Ç–∞—Ç—É—Å—ã
‚Ä¢ **–†–∞–±–æ—Ç–∞—Ö** ‚Äî —É—á—ë—Ç, —Ä–∞—Å—Ö–æ–¥—ã
‚Ä¢ **–§–∏–Ω–∞–Ω—Å–∞—Ö** ‚Äî –¥–æ—Ö–æ–¥—ã, —Ä–∞—Å—Ö–æ–¥—ã
‚Ä¢ **–ü–µ—Ä—Å–æ–Ω–∞–ª–µ** ‚Äî –¥—Ä—É–∂–∏–Ω–∞, –≥—Ä–∞—Ñ–∏–∫–∏
‚Ä¢ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ö** ‚Äî –¥–æ–≥–æ–≤–æ—Ä—ã, –ø–µ—á–∞—Ç–∏

–ò–ª–∏ –Ω–∞–ø–∏—à–∏ **¬´–ø–æ–º–æ—â—å¬ª** –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.`
    };
    
    for (const [key, response] of Object.entries(responses)) {
      if (key !== 'default' && lowerText.includes(key)) {
        return response;
      }
    }
    
    return responses.default;
  }

  return {
    init,
    open: () => { isOpen = true; document.getElementById('mimirPanel')?.classList.add('open'); },
    close: () => { isOpen = false; document.getElementById('mimirPanel')?.classList.remove('open'); },
    clearHistory: () => { messages = []; renderMessages(); },
    askQuestion: (q) => { document.getElementById('mimirInput').value = q; sendMessage(); }
  };
})();

document.addEventListener('DOMContentLoaded', () => AsgardMimir.init());
window.addEventListener('hashchange', () => AsgardMimir.init());
