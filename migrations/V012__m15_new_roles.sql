-- ═══════════════════════════════════════════════════════════════
-- M15: Новые роли — HEAD_TO, HEAD_PM, CHIEF_ENGINEER, HR_MANAGER
-- ═══════════════════════════════════════════════════════════════

-- Таблица role не enum, а VARCHAR в users — новые значения добавляются автоматически.
-- Проверяем что колонка roles (TEXT) существует для мульти-ролей:
ALTER TABLE users ADD COLUMN IF NOT EXISTS roles TEXT;

-- Аналитические кэш-таблицы (опционально, для быстрых dashboard запросов):
CREATE TABLE IF NOT EXISTS role_analytics_cache (
  id SERIAL PRIMARY KEY,
  role VARCHAR(50) NOT NULL,
  user_id INTEGER REFERENCES users(id),
  metric_key VARCHAR(100) NOT NULL,
  metric_value NUMERIC(15,2) DEFAULT 0,
  period VARCHAR(20),
  calculated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(role, user_id, metric_key, period)
);

CREATE INDEX IF NOT EXISTS idx_role_analytics_role ON role_analytics_cache(role);
CREATE INDEX IF NOT EXISTS idx_role_analytics_user ON role_analytics_cache(user_id);

-- Добавляем permit_types если ещё нет (для HR_MANAGER — управление типами разрешений):
CREATE TABLE IF NOT EXISTS permit_types (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  category VARCHAR(100),
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Начальный справочник (если пуст):
INSERT INTO permit_types (name, category) VALUES
  ('Газоопасные работы', 'Допуски'),
  ('Работы в замкнутых пространствах', 'Допуски'),
  ('Высотные работы (>1.8м)', 'Допуски'),
  ('Работы на шельфе/МЛСП', 'Допуски'),
  ('Работы с электроустановками до 1000В', 'Допуски'),
  ('Работы с электроустановками свыше 1000В', 'Допуски'),
  ('Стропальные работы', 'Допуски'),
  ('Работы с грузоподъёмными механизмами', 'Допуски'),
  ('Огневые/сварочные работы', 'Допуски'),
  ('Работы на высоте (промальп)', 'Допуски'),
  ('Работы с СИЗОД', 'Допуски'),
  ('Пожарная безопасность', 'Удостоверения'),
  ('Охрана труда', 'Удостоверения'),
  ('Экологическая безопасность', 'Удостоверения'),
  ('Промышленная безопасность А.1', 'Удостоверения'),
  ('Промышленная безопасность Б.2', 'Удостоверения'),
  ('Промышленная безопасность Б.8', 'Удостоверения'),
  ('Удостоверение НАКС (сварка)', 'Удостоверения'),
  ('Удостоверение по тепловым энергоустановкам', 'Удостоверения'),
  ('Медосмотр (периодический)', 'Медицина'),
  ('Психиатрическое освидетельствование', 'Медицина'),
  ('Работа в районах Крайнего Севера', 'Медицина'),
  ('Допуск к работе на высоте 1 группа', 'Группы высоты'),
  ('Допуск к работе на высоте 2 группа', 'Группы высоты'),
  ('Допуск к работе на высоте 3 группа', 'Группы высоты'),
  ('Безопасность на нефтегазовом объекте', 'Допуски'),
  ('Пропуск на объект (МЛСП Приразломная)', 'Пропуска'),
  ('Пропуск на объект (Сахалин)', 'Пропуска'),
  ('Пропуск на объект (Каспий)', 'Пропуска'),
  ('Удостоверение оператора котельной', 'Удостоверения'),
  ('Удостоверение по сосудам под давлением', 'Удостоверения'),
  ('Допуск к работе с радиоактивными источниками', 'Допуски'),
  ('Аттестация по неразрушающему контролю', 'Удостоверения'),
  ('Монтаж технологических трубопроводов', 'Допуски'),
  ('Химическая чистка оборудования', 'Допуски'),
  ('Работы в охранных зонах ЛЭП', 'Допуски'),
  ('Земляные работы', 'Допуски'),
  ('Работа с пескоструйным оборудованием', 'Допуски'),
  ('Антикоррозийная защита', 'Допуски'),
  ('Изоляционные работы', 'Допуски'),
  ('Работы с ЛКМ в закрытых помещениях', 'Допуски'),
  ('Допуск к работам на объектах Газпром', 'Пропуска'),
  ('Допуск к работам на объектах Роснефть', 'Пропуска'),
  ('Допуск к работам на объектах ЛУКОЙЛ', 'Пропуска'),
  ('Первая помощь', 'Обучение'),
  ('Пожарно-технический минимум', 'Обучение')
ON CONFLICT DO NOTHING;
