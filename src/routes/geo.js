/**
 * Geo Routes - Расчёт расстояний
 */

// Известные города с координатами
const KNOWN_CITIES = {
  'москва': [55.7558, 37.6173],
  'санкт-петербург': [59.9343, 30.3351],
  'спб': [59.9343, 30.3351],
  'новосибирск': [55.0084, 82.9357],
  'екатеринбург': [56.8389, 60.6057],
  'казань': [55.7887, 49.1221],
  'нижний новгород': [56.2965, 43.9361],
  'челябинск': [55.1644, 61.4368],
  'самара': [53.1959, 50.1002],
  'ростов-на-дону': [47.2357, 39.7015],
  'уфа': [54.7388, 55.9721],
  'красноярск': [56.0153, 92.8932],
  'пермь': [58.0105, 56.2502],
  'воронеж': [51.6755, 39.2089],
  'волгоград': [48.7080, 44.5133],
  'краснодар': [45.0355, 38.9753],
  'мурманск': [68.9585, 33.0827],
  'архангельск': [64.5399, 40.5152],
  'южно-сахалинск': [46.9641, 142.7285],
  'владивосток': [43.1332, 131.9113],
  'хабаровск': [48.4827, 135.0838],
  'якутск': [62.0355, 129.6755],
  'норильск': [69.3535, 88.2027],
  'сургут': [61.2500, 73.4167],
  'нижневартовск': [60.9344, 76.5531],
  'тюмень': [57.1522, 65.5272],
  'омск': [54.9885, 73.3242],
  'томск': [56.4977, 84.9744],
  'иркутск': [52.2978, 104.2964],
  'чита': [52.0515, 113.4712],
  'калининград': [54.7104, 20.4522],
  'сочи': [43.5855, 39.7231],
  'астрахань': [46.3497, 48.0408],
  'саратов': [51.5336, 46.0343],
  'ярославль': [57.6261, 39.8845],
  'тула': [54.1961, 37.6182],
  'рязань': [54.6269, 39.6916],
  'владимир': [56.1366, 40.3966],
  'тверь': [56.8587, 35.9176],
  'смоленск': [54.7903, 32.0503],
  'калуга': [54.5293, 36.2754],
  'орёл': [52.9651, 36.0785],
  'курск': [51.7373, 36.1874],
  'белгород': [50.5997, 36.5986],
  'липецк': [52.6031, 39.5708],
  'тамбов': [52.7212, 41.4523],
  'пенза': [53.1959, 45.0183],
  'ульяновск': [54.3142, 48.4031],
  'оренбург': [51.7879, 55.1019],
  'магнитогорск': [53.4071, 58.9793],
  'нарьян-мар': [67.6380, 53.0069],
  'салехард': [66.5300, 66.6019],
  'ханты-мансийск': [61.0042, 69.0019],
  'новый уренгой': [66.0833, 76.6333],
  'ноябрьск': [63.2011, 75.4511],
  'когалым': [62.2667, 74.4833],
  'нефтеюганск': [61.0833, 72.7000],
  'приразломное': [69.25, 57.35],
  'варандей': [68.8231, 58.0681],
  'печора': [65.1500, 57.2167],
  'усинск': [66.0000, 57.5333],
  'ухта': [63.5667, 53.7000],
  'воркута': [67.5000, 64.0333],
  'сыктывкар': [61.6667, 50.8167],
  'вологда': [59.2200, 39.8800],
  'череповец': [59.1269, 37.9096],
  'петрозаводск': [61.7833, 34.3500],
  'псков': [57.8167, 28.3333],
  'великий новгород': [58.5167, 31.2833],
  'брянск': [53.2500, 34.3667],
  'иваново': [57.0000, 40.9833],
  'кострома': [57.7667, 40.9333],
  'киров': [58.6000, 49.6500],
  'чебоксары': [56.1333, 47.2500],
  'йошкар-ола': [56.6333, 47.8667],
  'саранск': [54.1833, 45.1833],
  'набережные челны': [55.7167, 52.4167],
  'тольятти': [53.5000, 49.4167],
  'ижевск': [56.8500, 53.2333],
  'курган': [55.4500, 65.3333],
  'барнаул': [53.3500, 83.7667],
  'бийск': [52.5333, 85.2000],
  'кемерово': [55.3500, 86.0833],
  'новокузнецк': [53.7500, 87.1167],
  'улан-удэ': [51.8333, 107.6000],
  'благовещенск': [50.2500, 127.5333],
  'комсомольск-на-амуре': [50.5500, 137.0167],
  'петропавловск-камчатский': [53.0167, 158.6500],
  'магадан': [59.5667, 150.8000],
  'анадырь': [64.7333, 177.5167],
};

// Формула гаверсинуса
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return Math.round(R * c);
}

async function routes(fastify, options) {
  
  // Геокодирование города
  fastify.get('/geocode', async (request) => {
    const { city } = request.query;
    
    if (!city) {
      return { error: 'Укажите город', coords: null };
    }
    
    const key = city.toLowerCase().trim();
    const coords = KNOWN_CITIES[key];
    
    if (coords) {
      return { city, coords, source: 'local' };
    }
    
    // Попытка найти частичное совпадение
    const partial = Object.keys(KNOWN_CITIES).find(k => k.includes(key) || key.includes(k));
    if (partial) {
      return { city, coords: KNOWN_CITIES[partial], source: 'partial', matched: partial };
    }
    
    return { city, coords: null, error: 'Город не найден' };
  });
  
  // Расчёт расстояния
  fastify.get('/distance', async (request) => {
    const { from, to } = request.query;
    
    if (!from || !to) {
      return { error: 'Укажите оба города: from и to' };
    }
    
    const fromKey = from.toLowerCase().trim();
    const toKey = to.toLowerCase().trim();
    
    const fromCoords = KNOWN_CITIES[fromKey];
    const toCoords = KNOWN_CITIES[toKey];
    
    if (!fromCoords) {
      return { error: `Город "${from}" не найден` };
    }
    if (!toCoords) {
      return { error: `Город "${to}" не найден` };
    }
    
    const directDist = haversineDistance(fromCoords[0], fromCoords[1], toCoords[0], toCoords[1]);
    const roadDist = Math.round(directDist * 1.3); // Коэффициент для автодорог
    
    return {
      from: { city: from, coords: fromCoords },
      to: { city: to, coords: toCoords },
      distance_direct_km: directDist,
      distance_road_km: roadDist
    };
  });
  
  // Список известных городов
  fastify.get('/cities', async () => {
    return {
      cities: Object.keys(KNOWN_CITIES).sort(),
      count: Object.keys(KNOWN_CITIES).length
    };
  });
}

module.exports = routes;
